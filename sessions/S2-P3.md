# **Session 2 - Partie 3 : Indexation et optimisation des performances**  

---

## **ğŸ¯ Objectifs pÃ©dagogiques**  

Ã€ la fin de cette session, vous serez capable de :  
âœ… Comprendre l'importance des index dans MongoDB.  
âœ… CrÃ©er et gÃ©rer diffÃ©rents types dâ€™index.  
âœ… Analyser les performances des requÃªtes avec `explain()`.  
âœ… Optimiser les requÃªtes pour amÃ©liorer lâ€™efficacitÃ© de MongoDB.  

---

## **ğŸ“š Contenu du cours**  

## **1ï¸âƒ£ Pourquoi utiliser les index en MongoDB ?**  

Les index permettent dâ€™**accÃ©lÃ©rer la recherche des documents** en Ã©vitant Ã  MongoDB de parcourir **toute la collection**.  

ğŸ”¹ **Sans index** : MongoDB doit analyser chaque document (**scan complet de la collection**).  
ğŸ”¹ **Avec index** : MongoDB trouve directement les documents correspondants (**recherche optimisÃ©e**).  

Les index sont **stockÃ©s sÃ©parÃ©ment** des documents et mis Ã  jour automatiquement.  

---

## **2ï¸âƒ£ Types dâ€™index en MongoDB**  

MongoDB propose plusieurs types dâ€™index pour rÃ©pondre Ã  diffÃ©rents besoins.  

### **ğŸ”¹ Index simple (Single Field Index)**  
CrÃ©Ã© sur **un seul champ** pour accÃ©lÃ©rer les requÃªtes sur ce champ.  
```sh
db.utilisateurs.createIndex({ "email": 1 })  # Index ascendant sur "email"
```
ğŸ“Œ **Explication** :  
âœ” `1` signifie **ordre croissant** (`-1` pour un index dÃ©croissant).  
âœ” Permet dâ€™accÃ©lÃ©rer les requÃªtes sur `email` (`find()`, `sort()`, etc.).  

### **ğŸ”¹ Index composÃ© (Compound Index)**  
CrÃ©Ã© sur **plusieurs champs** pour optimiser les recherches multi-critÃ¨res.  
```sh
db.utilisateurs.createIndex({ "nom": 1, "age": -1 })
```
ğŸ“Œ **Explication** :  
âœ” Utile pour les recherches sur `nom` et `age`.  
âœ” Lâ€™ordre des champs est **important** : un index sur `nom, age` nâ€™est pas Ã©quivalent Ã  un index sur `age, nom`.  

### **ğŸ”¹ Index unique (Unique Index)**  
EmpÃªche lâ€™insertion de valeurs en double sur un champ spÃ©cifique.  
```sh
db.utilisateurs.createIndex({ "email": 1 }, { unique: true })
```
ğŸ“Œ **Explication** :  
âœ” Garantit que **chaque email est unique** dans la collection.  
âœ” Essayer dâ€™insÃ©rer un email dÃ©jÃ  existant gÃ©nÃ¨re une **erreur**.  

### **ğŸ”¹ Index texte (Text Index)**  
Permet dâ€™effectuer des **recherches textuelles**.  
```sh
db.produits.createIndex({ "description": "text" })
```
ğŸ“Œ **Explication** :  
âœ” Permet la recherche rapide de mots dans un champ texte.  
âœ” Utilisable avec `$text` dans `find()`.  

Exemple dâ€™utilisation :  
```sh
db.produits.find({ "$text": { "$search": "ordinateur" } })
```

### **ğŸ”¹ Index gÃ©ospatial (Geospatial Index)**  
UtilisÃ© pour **stocker et rechercher des donnÃ©es gÃ©ographiques** (latitude, longitude).  
```sh
db.magasins.createIndex({ "location": "2dsphere" })
```
ğŸ“Œ **Explication** :  
âœ” NÃ©cessaire pour des requÃªtes comme **"trouver le magasin le plus proche"**.  

---

## **3ï¸âƒ£ Analyser les performances avec `explain()`**  

MongoDB permet dâ€™analyser les performances des requÃªtes avec `explain()`.  

### **ğŸ”¹ Exemple sans index (Scan complet de collection)**  
```sh
db.utilisateurs.find({ "nom": "Alice" }).explain("executionStats")
```
ğŸ“Œ **Explication** :  
âœ” Affiche des statistiques sur l'exÃ©cution de la requÃªte.  
âœ” VÃ©rifier le champ `"totalDocsExamined"` â†’ si **Ã©gal au nombre total de documents**, lâ€™indexation est absente.  

### **ğŸ”¹ Exemple avec index (RequÃªte optimisÃ©e)**  
```sh
db.utilisateurs.createIndex({ "nom": 1 })  # CrÃ©ation d'un index
db.utilisateurs.find({ "nom": "Alice" }).explain("executionStats")
```
ğŸ“Œ **Explication** :  
âœ” AprÃ¨s lâ€™indexation, `"totalDocsExamined"` est rÃ©duit, amÃ©liorant la performance.  

---

## **4ï¸âƒ£ Optimisation des requÃªtes MongoDB**  

### **ğŸ”¹ Utiliser des index sur les champs frÃ©quemment recherchÃ©s**  
**Bonne pratique** : Indexer les champs utilisÃ©s dans **find(), sort(), group()**.  

Exemple :  
```sh
db.commandes.createIndex({ "date": -1 })  # Optimisation des requÃªtes triÃ©es par date
```

### **ğŸ”¹ Ã‰viter `find()` sans filtres**  
âŒ **Mauvaise pratique** :  
```sh
db.utilisateurs.find()
```
âœ” **Bonne pratique** (utilisation dâ€™un index) :  
```sh
db.utilisateurs.find({ "age": { "$gt": 30 } })
```

### **ğŸ”¹ Supprimer les index inutilisÃ©s**  
```sh
db.utilisateurs.dropIndex("nom_1")  # Supprime un index nommÃ© "nom_1"
```
ğŸ“Œ **Explication** :  
âœ” Les index inutilisÃ©s prennent de la place et ralentissent les insertions/mises Ã  jour.  

---

## **5ï¸âƒ£ Utilisation de MongoDB Compass pour gÃ©rer les index**  

### **ğŸ”¹ CrÃ©er un index**  
1ï¸âƒ£ Ouvrir MongoDB Compass.  
2ï¸âƒ£ SÃ©lectionner une **base de donnÃ©es** et une **collection**.  
3ï¸âƒ£ Aller dans lâ€™onglet **Indexes**.  
4ï¸âƒ£ Cliquer sur **"Create Index"** et choisir les champs Ã  indexer.  

### **ğŸ”¹ VÃ©rifier lâ€™impact des index**  
1ï¸âƒ£ Aller dans lâ€™onglet **Query Performance**.  
2ï¸âƒ£ ExÃ©cuter une requÃªte et observer le nombre de **documents examinÃ©s**.  
3ï¸âƒ£ Comparer avec et sans index.  

---

## **ğŸ› ï¸ ActivitÃ©s pratiques**  

### **Exercice 1 : Optimisation dâ€™une base de donnÃ©es utilisateurs**  
ğŸ“Œ **Objectif** : AmÃ©liorer les performances des requÃªtes avec des index.  

1ï¸âƒ£ **CrÃ©er une collection `utilisateurs`** avec des champs `nom`, `email`, `age`, `ville`.  
2ï¸âƒ£ **InsÃ©rer au moins 10 000 utilisateurs** avec des donnÃ©es alÃ©atoires.  
3ï¸âƒ£ **ExÃ©cuter une requÃªte sans index** et observer `explain("executionStats")`.  
4ï¸âƒ£ **CrÃ©er un index sur `email` et `ville`**.  
5ï¸âƒ£ **Re-exÃ©cuter la requÃªte** et comparer la performance.  
6ï¸âƒ£ **Supprimer un index inutile**.  

---

## **ğŸ“– Questions de rÃ©vision**  

âœ” Pourquoi les index sont-ils importants en MongoDB ?  
âœ” Quelle est la diffÃ©rence entre un **index simple** et un **index composÃ©** ?  
âœ” Comment analyser les performances dâ€™une requÃªte avec `explain()` ?  
âœ” Quels sont les effets nÃ©gatifs des index ?  
âœ” Comment supprimer un index inutile ?  
