# **Session 3 - Partie 3 : Bonnes pratiques pour dÃ©velopper avec MongoDB**  

---

## **ğŸ¯ Objectifs pÃ©dagogiques**  

Ã€ la fin de cette session, vous serez capable de :  
âœ… Structurer efficacement vos bases et collections en MongoDB.  
âœ… Ã‰viter les erreurs courantes dans la modÃ©lisation et lâ€™utilisation de MongoDB.  
âœ… Optimiser les requÃªtes pour amÃ©liorer la performance de votre application.  
âœ… Suivre les meilleures pratiques pour maintenir une base MongoDB propre et efficace.  

---

## **ğŸ“š Contenu du cours**  

## **1ï¸âƒ£ Bonnes pratiques de modÃ©lisation des donnÃ©es**  

### **ğŸ”¹ Choisir entre embedding et referencing**  

| Approche | Quand lâ€™utiliser ? | Exemple |
|----------|------------------|---------|
| **Embedding** (donnÃ©es imbriquÃ©es) | Lorsque les donnÃ©es sont **fortement liÃ©es** et souvent lues ensemble | Un utilisateur et ses adresses |
| **Referencing** (rÃ©fÃ©rences entre collections) | Lorsque les donnÃ©es sont **rÃ©utilisÃ©es ailleurs** et doivent Ãªtre mises Ã  jour indÃ©pendamment | Un produit rÃ©fÃ©rencÃ© dans plusieurs commandes |

âœ” **Exemple dâ€™Embedding** *(Utilisateur avec plusieurs adresses)* :  
```json
{
  "_id": ObjectId("602d2149e773f2a3990b47f5"),
  "nom": "Alice Dupont",
  "email": "alice@email.com",
  "adresses": [
    { "rue": "10 rue de Paris", "ville": "Paris" },
    { "rue": "5 avenue Lyon", "ville": "Lyon" }
  ]
}
```
âœ” **Exemple de Referencing** *(Commande rÃ©fÃ©rencÃ©e dans un utilisateur)* :  
```json
{
  "_id": ObjectId("602d2149e773f2a3990b47f5"),
  "nom": "Alice Dupont",
  "email": "alice@email.com",
  "commandes": [ ObjectId("603d2149e773f2a3990b47a3"), ObjectId("603d2149e773f2a3990b47a4") ]
}
```
ğŸ“Œ **RÃ¨gle gÃ©nÃ©rale** : **Embedding pour la lecture rapide**, **Referencing pour Ã©viter la duplication** et faciliter les mises Ã  jour.  

---

## **2ï¸âƒ£ Bonnes pratiques pour Ã©viter les erreurs courantes**  

### **ğŸ”¹ Erreur 1 : Mauvais choix de structure**  
âŒ **Mauvaise pratique** *(Stocker une liste Ã©norme dans un seul document)* :  
```json
{
  "_id": ObjectId("602d2149e773f2a3990b47f5"),
  "nom": "Grosse catÃ©gorie",
  "produits": [ "Produit1", "Produit2", "Produit3", "... (10000 Ã©lÃ©ments) ..." ]
}
```
âœ” **Solution** *(Utiliser une collection sÃ©parÃ©e avec referencing)* :  
```json
{
  "_id": ObjectId("603d2149e773f2a3990b47a3"),
  "nom": "Produit1",
  "categorie_id": ObjectId("602d2149e773f2a3990b47f5")
}
```

### **ğŸ”¹ Erreur 2 : Ne pas indexer les champs utilisÃ©s frÃ©quemment**  
âŒ **Mauvaise pratique** :  
```sh
db.utilisateurs.find({ "email": "alice@email.com" })  # Aucun index
```
âœ” **Solution** *(CrÃ©er un index pour accÃ©lÃ©rer les recherches)* :  
```sh
db.utilisateurs.createIndex({ "email": 1 })
```

### **ğŸ”¹ Erreur 3 : Faire trop de requÃªtes lourdes**  
âŒ **Mauvaise pratique** *(Plusieurs requÃªtes au lieu dâ€™une agrÃ©gation)* :  
```sh
client = db.utilisateurs.findOne({ "nom": "Alice Dupont" })
commandes = db.commandes.find({ "client_id": client["_id"] })
```
âœ” **Solution** *(Utiliser `$lookup` pour rÃ©cupÃ©rer tout en une seule requÃªte)* :  
```sh
db.utilisateurs.aggregate([
  {
    "$lookup": {
      "from": "commandes",
      "localField": "_id",
      "foreignField": "client_id",
      "as": "commandes"
    }
  }
])
```

---

## **3ï¸âƒ£ Bonnes pratiques pour optimiser les performances**  

### **ğŸ”¹ Indexer les bons champs**  
ğŸ“Œ **Toujours crÃ©er des index sur les champs frÃ©quemment recherchÃ©s.**  

âœ” **Exemple : Indexer un champ utilisÃ© dans des `find()` ou `sort()`**  
```sh
db.commandes.createIndex({ "date": -1 })  # AccÃ©lÃ¨re le tri par date
```
ğŸ“Œ **Attention** : Trop dâ€™index ralentissent les insertions et consomment de lâ€™espace disque.  

---

### **ğŸ”¹ Limiter la taille des documents**  
ğŸ“Œ **MongoDB limite la taille dâ€™un document Ã  16MB.**  
âœ” **Ã‰viter dâ€™imbriquer trop de sous-documents**.  
âœ” **Stocker les gros fichiers ailleurs** (GridFS, AWS S3â€¦).  

---

### **ğŸ”¹ Utiliser les projections pour limiter la quantitÃ© de donnÃ©es renvoyÃ©es**  
ğŸ“Œ **Ne rÃ©cupÃ©rer que les champs nÃ©cessaires dans `find()`**.  

âŒ **Mauvaise pratique** *(RÃ©cupÃ©rer tout)* :  
```sh
db.utilisateurs.find()
```
âœ” **Bonne pratique** *(Ne rÃ©cupÃ©rer que `nom` et `email`)* :  
```sh
db.utilisateurs.find({}, { "nom": 1, "email": 1, "_id": 0 })
```

---

## **4ï¸âƒ£ Bonnes pratiques pour le dÃ©veloppement en Ã©quipe**  

### **ğŸ”¹ Standardiser les noms des collections et des champs**  
ğŸ“Œ **Utiliser des conventions claires** :  
âœ” **Collections en pluriel** : `utilisateurs`, `produits`, `commandes`  
âœ” **Champs en camelCase** : `nomUtilisateur`, `adresseEmail`  

### **ğŸ”¹ Utiliser des outils de validation des donnÃ©es**  
ğŸ“Œ **Assurer la cohÃ©rence des donnÃ©es avec des schÃ©mas JSON**.  
âœ” Exemple avec **Mongoose** (Node.js) :  
```js
const utilisateurSchema = new mongoose.Schema({
  nom: String,
  email: { type: String, required: true, unique: true },
  age: { type: Number, min: 18 }
})
```

### **ğŸ”¹ Mettre en place un environnement de test**  
âœ” **Utiliser une base de test distincte** (ex: `mongodb://localhost:27017/test`).  
âœ” **CrÃ©er des jeux de donnÃ©es pour tester les requÃªtes avant production**.  

---

## **5ï¸âƒ£ Utilisation de MongoDB Compass pour optimiser les bases**  

### **ğŸ”¹ VÃ©rifier les index existants**  
1ï¸âƒ£ Ouvrir MongoDB Compass.  
2ï¸âƒ£ SÃ©lectionner une **base de donnÃ©es** et une **collection**.  
3ï¸âƒ£ Aller dans lâ€™onglet **Indexes** pour voir les index existants.  

### **ğŸ”¹ Utiliser lâ€™analyse de requÃªte**  
1ï¸âƒ£ ExÃ©cuter une requÃªte dans Compass.  
2ï¸âƒ£ Cliquer sur **"Explain Plan"** pour voir si MongoDB fait un **scan complet** ou utilise un **index**.  
3ï¸âƒ£ Ajuster les index si nÃ©cessaire.  

---

## **ğŸ› ï¸ ActivitÃ©s pratiques**  

### **Exercice 1 : Optimisation et bonnes pratiques sur une base e-commerce**  
ğŸ“Œ **Objectif** : Appliquer les bonnes pratiques sur une base MongoDB existante.  

1ï¸âƒ£ **CrÃ©er une collection `produits`** avec des champs `nom`, `prix`, `categorie`, `stock`.  
2ï¸âƒ£ **CrÃ©er une collection `commandes`** avec `client_id` et une liste de produits.  
3ï¸âƒ£ **Optimiser la structure** :  
   - Embedding ou referencing pour `produits` dans `commandes` ?  
   - Ajouter un index sur `categorie` pour accÃ©lÃ©rer les recherches.  
4ï¸âƒ£ **ExÃ©cuter une requÃªte avec `$lookup`** pour afficher les commandes avec les dÃ©tails des produits.  
5ï¸âƒ£ **Utiliser `explain()`** pour analyser la performance dâ€™une requÃªte.  

---

## **ğŸ“– Questions de rÃ©vision**  

âœ” Quelle est la diffÃ©rence entre **embedding** et **referencing** ?  
âœ” Comment Ã©viter les **requÃªtes trop lourdes** ?  
âœ” Quelles sont les **bonnes pratiques** pour nommer les collections et les champs ?  
âœ” Comment utiliser MongoDB Compass pour analyser les performances ?  
