# **Session 2 - Partie 2 : RequÃªtes avancÃ©es et filtres**  

---

## **ðŸŽ¯ Objectifs pÃ©dagogiques**  

Ã€ la fin de cette session, vous serez capable de :  
âœ… Comprendre et utiliser les opÃ©rateurs avancÃ©s de MongoDB.  
âœ… Filtrer les documents avec des conditions complexes.  
âœ… Effectuer des recherches textuelles et des tris.  
âœ… Utiliser les agrÃ©gations pour manipuler et transformer les donnÃ©es.  

---

## **ðŸ“š Contenu du cours**  

## **1ï¸âƒ£ Introduction aux opÃ©rateurs avancÃ©s**  

MongoDB offre une grande flexibilitÃ© dans les requÃªtes grÃ¢ce Ã  ses **opÃ©rateurs avancÃ©s**.  

ðŸ”¹ **OpÃ©rateurs de comparaison** : `$gt`, `$lt`, `$eq`, `$ne`, `$in`, `$nin`.  
ðŸ”¹ **OpÃ©rateurs logiques** : `$and`, `$or`, `$not`, `$nor`.  
ðŸ”¹ **Recherches avancÃ©es** : `$regex`, `$text`.  
ðŸ”¹ **Tri et limitation des rÃ©sultats** : `sort()`, `limit()`, `skip()`.  
ðŸ”¹ **AgrÃ©gation et transformation des donnÃ©es** : `$group`, `$sum`, `$avg`, `$lookup`.  

---

## **2ï¸âƒ£ OpÃ©rateurs de comparaison**  

Ces opÃ©rateurs permettent de filtrer les documents selon des valeurs spÃ©cifiques.  

### **ðŸ”¹ Rechercher des documents avec `$gt` et `$lt` (supÃ©rieur et infÃ©rieur)**  
```sh
db.produits.find({ "prix": { "$gt": 50 } })  # Produits dont le prix est > 50
db.produits.find({ "stock": { "$lt": 100 } })  # Produits avec stock < 100
```

### **ðŸ”¹ Rechercher des documents avec `$eq` et `$ne` (Ã©gal et diffÃ©rent)**  
```sh
db.produits.find({ "categorie": { "$eq": "Informatique" } })  # Produits en "Informatique"
db.produits.find({ "categorie": { "$ne": "Informatique" } })  # Produits hors "Informatique"
```

### **ðŸ”¹ Rechercher des valeurs dans une liste avec `$in` et `$nin`**  
```sh
db.produits.find({ "categorie": { "$in": ["Informatique", "Bureau"] } })  # Produits en "Informatique" ou "Bureau"
db.produits.find({ "categorie": { "$nin": ["Informatique", "Bureau"] } })  # Exclut ces catÃ©gories
```

---

## **3ï¸âƒ£ OpÃ©rateurs logiques**  

### **ðŸ”¹ Combiner des conditions avec `$and` et `$or`**  
```sh
db.produits.find({
  "$and": [
    { "prix": { "$gt": 50 } },
    { "stock": { "$lt": 100 } }
  ]
})  # Produits coÃ»tant plus de 50â‚¬ et ayant un stock < 100
```
```sh
db.produits.find({
  "$or": [
    { "categorie": "Informatique" },
    { "categorie": "Bureau" }
  ]
})  # Produits en "Informatique" ou "Bureau"
```

### **ðŸ”¹ Exclure des rÃ©sultats avec `$not` et `$nor`**  
```sh
db.produits.find({ "stock": { "$not": { "$gt": 50 } } })  # Stock <= 50
db.produits.find({ "$nor": [ { "categorie": "Informatique" }, { "prix": { "$lt": 100 } } ] })  # Ni "Informatique", ni prix < 100
```

---

## **4ï¸âƒ£ Recherches avancÃ©es**  

### **ðŸ”¹ Recherche textuelle avec `$text`**  
MongoDB permet dâ€™effectuer des recherches sur des champs texte avec un **index de texte**.  

1ï¸âƒ£ **CrÃ©er un index texte sur un champ**  
```sh
db.produits.createIndex({ "nom": "text" })
```
2ï¸âƒ£ **Rechercher un mot-clÃ© dans les noms de produits**  
```sh
db.produits.find({ "$text": { "$search": "ordinateur" } })
```
3ï¸âƒ£ **Recherche dâ€™une expression exacte**  
```sh
db.produits.find({ "$text": { "$search": "\"ordinateur portable\"" } })
```

### **ðŸ”¹ Recherche avancÃ©e avec `$regex` (expressions rÃ©guliÃ¨res)**  
```sh
db.produits.find({ "nom": { "$regex": "^O", "$options": "i" } })  # Produits dont le nom commence par "O" (insensible Ã  la casse)
```

---

## **5ï¸âƒ£ Trier et limiter les rÃ©sultats**  

### **ðŸ”¹ Trier les rÃ©sultats avec `sort()`**  
```sh
db.produits.find().sort({ "prix": 1 })  # Trie par prix croissant
db.produits.find().sort({ "prix": -1 })  # Trie par prix dÃ©croissant
```

### **ðŸ”¹ Limiter et ignorer des rÃ©sultats avec `limit()` et `skip()`**  
```sh
db.produits.find().limit(5)  # RÃ©cupÃ¨re seulement 5 produits
db.produits.find().skip(5).limit(5)  # Ignore les 5 premiers et rÃ©cupÃ¨re les 5 suivants
```

---

## **6ï¸âƒ£ AgrÃ©gation des donnÃ©es**  

Lâ€™**agrÃ©gation** permet de **transformer et analyser** les donnÃ©es Ã  lâ€™aide de plusieurs opÃ©rations en chaÃ®ne.  

### **ðŸ”¹ Grouper et compter avec `$group` et `$sum`**  
```sh
db.produits.aggregate([
  { "$group": { "_id": "$categorie", "nombre_produits": { "$sum": 1 } } }
])
```
ðŸ“Œ **Explication** :  
âœ” Regroupe les produits par `categorie` et compte combien il y en a.  

### **ðŸ”¹ Calculer des moyennes avec `$avg`**  
```sh
db.produits.aggregate([
  { "$group": { "_id": "$categorie", "prix_moyen": { "$avg": "$prix" } } }
])
```
ðŸ“Œ **Explication** :  
âœ” Calcule la **moyenne des prix** pour chaque catÃ©gorie.  

### **ðŸ”¹ Faire une jointure avec `$lookup`**  
```sh
db.commandes.aggregate([
  {
    "$lookup": {
      "from": "clients",
      "localField": "client_id",
      "foreignField": "_id",
      "as": "informations_client"
    }
  }
])
```
ðŸ“Œ **Explication** :  
âœ” Associe chaque commande Ã  son client en reliant `client_id` avec `_id` de la collection `clients`.  

---

## **7ï¸âƒ£ Utilisation de MongoDB Compass pour les requÃªtes avancÃ©es**  

### **ðŸ”¹ Effectuer des filtres complexes**  
1ï¸âƒ£ Ouvrir MongoDB Compass et se connecter.  
2ï¸âƒ£ Dans la section **FILTER**, entrer une requÃªte, par exemple :  
   ```json
   { "prix": { "$gt": 100 } }
   ```
3ï¸âƒ£ Utiliser les boutons **SORT** et **LIMIT** pour organiser les rÃ©sultats.  

### **ðŸ”¹ ExÃ©cuter une agrÃ©gation avec MongoDB Compass**  
1ï¸âƒ£ Aller dans **Aggregations**.  
2ï¸âƒ£ Ajouter un **stage `$group`** pour regrouper les donnÃ©es.  
3ï¸âƒ£ Ajouter un **stage `$sort`** pour trier les rÃ©sultats.  

---

## **ðŸ› ï¸ ActivitÃ©s pratiques**  

### **Exercice 1 : RequÃªtes avancÃ©es sur une base de films**  
ðŸ“Œ **Objectif** : Analyser une base de donnÃ©es de films et effectuer des requÃªtes avancÃ©es.  

1ï¸âƒ£ **CrÃ©er une collection `films` et insÃ©rer plusieurs documents** avec les champs : `titre`, `genre`, `annÃ©e`, `note_imdb`, `acteurs`.  
2ï¸âƒ£ **Rechercher tous les films sortis aprÃ¨s 2010** (`$gt`).  
3ï¸âƒ£ **Lister tous les films du genre "Science-Fiction" ou "Action"** (`$or`).  
4ï¸âƒ£ **Trouver les films avec une note supÃ©rieure Ã  8.5** (`$gt`).  
5ï¸âƒ£ **Calculer la note moyenne par genre** (`$group` et `$avg`).  
6ï¸âƒ£ **Afficher uniquement les titres et les notes** (`projection`).  
7ï¸âƒ£ **Trier les films par note dÃ©croissante** (`sort()`).  

---

## **ðŸ“– Questions de rÃ©vision**  

âœ” Quelle est la diffÃ©rence entre `$gt`, `$lt`, `$eq` et `$ne` ?  
âœ” Comment effectuer une recherche textuelle en MongoDB ?  
âœ” Quels sont les principaux opÃ©rateurs dâ€™agrÃ©gation ?  
âœ” Comment utiliser `$lookup` pour joindre deux collections ?  
